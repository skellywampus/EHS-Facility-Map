<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Facility Map</title>
    <style>
      html,
      body {
        height: 100%;
        margin: 0;
        font-family: system-ui, Segoe UI, Roboto, Arial, sans-serif;
      }

      .app {
        display: grid;
        grid-template-columns: 320px 1fr;
        height: 100%;
      }

      .panel {
        padding: 12px;
        border-right: 1px solid #ddd;
        overflow: auto;
      }

      .panel h2 {
        font-size: 16px;
        margin: 8px 0;
      }

      .panel h3 {
        font-size: 14px;
        margin: 10px 0 6px;
      }

      .panel label {
        display: block;
        font-size: 12px;
        margin: 6px 0 3px;
      }

      .panel input[type="text"],
      .panel input[type="password"],
      .panel input[type="number"],
      .panel select {
        width: 100%;
        padding: 6px;
        box-sizing: border-box;
      }

      .panel button {
        padding: 6px 8px;
        margin: 6px 0;
      }

      .row {
        display: flex;
        gap: 8px;
        align-items: center;
      }

      .row>* {
        flex: 1;
      }

      #stageWrap {
        position: relative;
        background: #f3f3f3;
      }

      #stage {
        width: 100%;
        height: 100%;
        display: block;
        background: #fafafa;
      }

      .legend {
        display: grid;
        grid-template-columns: 1fr;
        gap: 6px;
        font-size: 12px;
      }

      .legend label {
        display: flex;
        align-items: center;
        gap: 8px;
      }

      .muted {
        color: #666;
        font-size: 12px;
      }

      .small {
        font-size: 12px;
      }

      .sep {
        border-top: 1px solid #e3e3e3;
        margin: 10px 0;
      }

      .pill {
        display: inline-block;
        padding: 2px 6px;
        border-radius: 10px;
        background: #eee;
        font-size: 12px;
      }

      .notice {
        background: #f6f8ff;
        border: 1px solid #dfe6ff;
        padding: 8px;
        font-size: 12px;
      }

      .danger {
        background: #fee;
        border: 1px solid #fcc;
        padding: 8px;
        font-size: 12px;
        display: none;
      }

      #tooltip {
        position: absolute;
        background: #fff;
        border: 1px solid #ccc;
        font-size: 12px;
        padding: 4px 6px;
        pointer-events: none;
        display: none;
        white-space: nowrap;
        z-index: 10;
        box-shadow: 0 2px 6px rgba(0, 0, 0, .1);
      }
    </style>
    <style>
      @media print {
        @media print {

          /* Hide entire legend row only if it has class print-hide */
          .legend label.print-hide {
            display: none !important;
          }

          /* Hide checkbox UI always on print */
          .legend label input[type="checkbox"] {
            display: none !important;
          }
        }

        /* Ensure colors and backgrounds are preserved */
        * {
          -webkit-print-color-adjust: exact !important;
          print-color-adjust: exact !important;
        }

        /* Hide non-essential UI */
        .row,
        #authBox,
        #adminBox,
        #tooltip,
        .notice,
        .danger,
        button,
        input,
        select {
          display: none !important;
        }

        /* Hide labels in panel EXCEPT legend labels */
        .panel label:not(.legend label) {
          display: none !important;
        }

        /* Hide all headings in sidebar */
        .panel h1,
        .panel h2,
        .panel h3,
        .panel h4,
        .panel h5,
        .panel h6,
        .muted,
        .sep {
          display: none !important;
        }

        /* Panel reduced to only legend */
        .panel {
          border: none !important;
          padding: 0 !important;
          width: auto !important;
        }

        /* Legend floats on map */
        .legend {
          position: absolute !important;
          bottom: 10px;
          left: 5px;
          background: #fff;
          border: 1px solid #ccc;
          padding: 6px;
          font-size: 10px;
          opacity: 0.9;
          z-index: 9999;
        }

        .legend label {
          display: flex;
          align-items: center;
          gap: 6px;
        }

        /* Always hide the checkbox box itself */
        .legend label input[type="checkbox"] {
          display: none !important;
        }

        /* Hide unchecked rows completely */
        .legend label input[type="checkbox"]:not(:checked) {
          /* hide the parent row instead of the input */
          display: none !important;
        }

        /* Expand map to page */
        .app {
          display: block !important;
        }

        #stageWrap,
        #stage {
          width: 100% !important;
          height: auto !important;
        }

        /* Force landscape page */
        @page {
          size: landscape;
          margin: 0.25in;
        }
      }
    </style>
  </head>
  <body>
    <div class="app">
      <aside class="panel">
        <h2>Facility Map</h2>
        <div class="muted small">A dynamic map that allows users to toggle items to only show relevant information.</div>
        <div class="row">
          <input type="file" id="pickImg" accept="image/*" style="display:none;">
        </div>
        <div class="sep"></div>
        <h3>Legend (visibility)</h3>
        <div class="legend" id="legend">
          <label>
            <input type="checkbox">
            <span>
              <svg width="18" height="18" viewBox="0 0 18 18" aria-hidden="true">
                <circle cx="9" cy="9" r="7" fill="#d32" stroke="white" stroke-width="2"></circle>
              </svg>
            </span>
            <span>Fire Extinguisher</span>
          </label>
          <label>
            <input type="checkbox">
            <span>
              <span style="display:inline-block;min-width:28px;padding:2px 6px;border-radius:999px;background:#0b5;color:#fff;font-weight:700;font-size:12px;text-align:center;">SK</span>
            </span>
            <span>Spill Kit</span>
          </label>
          <label>
            <input type="checkbox">
            <span>
              <svg width="18" height="18" viewBox="0 0 18 18" aria-hidden="true">
                <polygon points="9,2 16,16 2,16" fill="#08c" stroke="white" stroke-width="2"></polygon>
              </svg>
            </span>
            <span>Emergency Shower</span>
          </label>
          <label>
            <input type="checkbox">
            <span>
              <svg width="18" height="18" viewBox="0 0 18 18" aria-hidden="true">
                <rect x="3" y="3" width="12" height="12" rx="3" fill="#6a3" stroke="white" stroke-width="2"></rect>
              </svg>
            </span>
            <span>Eyewash</span>
          </label>
          <label>
            <input type="checkbox">
            <span>
              <span style="display:inline-block;min-width:28px;padding:2px 6px;border-radius:999px;background:#7b1fa2;color:#fff;font-weight:700;font-size:12px;text-align:center;">EP</span>
            </span>
            <span>Emission Point</span>
          </label>
          <label>
            <input type="checkbox">
            <span>
              <svg width="18" height="18" viewBox="0 0 18 18" aria-hidden="true">
                <polygon points="4,5 9,2 14,5 14,13 9,16 4,13" fill="#1e88e5" stroke="white" stroke-width="2"></polygon>
              </svg>
            </span>
            <span>Stormwater Outfall</span>
          </label>
          <label>
            <input type="checkbox">
            <span>
              <svg width="18" height="18" viewBox="0 0 18 18" aria-hidden="true">
                <rect x="3" y="3" width="12" height="12" rx="3" fill="#ef6c00" stroke="white" stroke-width="2"></rect>
              </svg>
            </span>
            <span>Bulk Chemical Storage</span>
          </label>
          <label>
            <input type="checkbox">
            <span>
              <svg width="18" height="18" viewBox="0 0 18 18" aria-hidden="true">
                <circle cx="9" cy="9" r="7" fill="#5d4037" stroke="white" stroke-width="2"></circle>
              </svg>
            </span>
            <span>Waste Accumulation Area</span>
          </label>
          <label>
            <input type="checkbox">
            <span>
              <span style="display:inline-block;min-width:28px;padding:2px 6px;border-radius:999px;background:#2e7d32;color:#fff;font-weight:700;font-size:12px;text-align:center;">SAFE</span>
            </span>
            <span>Safer Area</span>
          </label>
          <label>
            <input type="checkbox">
            <span>
              <span style="display:inline-block;min-width:28px;padding:2px 6px;border-radius:999px;background:#c2185b;color:#fff;font-weight:700;font-size:12px;text-align:center;">EVAC</span>
            </span>
            <span>Evacuation Point</span>
          </label>
        </div>
        <div class="sep"></div>
        <h3>View</h3>
        <label>Zoom</label>
        <div class="row">
          <button id="zoomOut">-</button>
          <button id="zoomReset">Reset</button>
          <button id="zoomIn">+</button>
        </div>
        <label>Rotate (Â°)</label>
        <div class="row">
          <input type="number" id="rotateDeg" value="0" step="1">
          <button data-rot="0">0</button>
          <button data-rot="90">90</button>
          <button data-rot="180">180</button>
          <button data-rot="270">270</button>
        </div>
        <button onclick="window.print()">Print Map</button>
        <div class="sep"></div>
        <h3>Admin</h3>
        <div id="authBox">
          <label>Password</label>
          <input type="password" id="pwd" placeholder="Password">
          <button id="loginBtn">Login</button>
        </div>
        <div id="adminBox" style="display:none;">
          <div class="row" style="align-items:center;">
            <span class="pill" id="status">Add: Off</span>
            <button id="logoutBtn">Logout</button>
          </div>
          <label for="typeSel">Item type</label>
          <select id="typeSel"></select>
          <div class="row">
            <button id="addToggleBtn">Toggle Add Mode</button>
            <button id="cancelAddBtn">Cancel</button>
          </div>
          <div class="sep"></div>
          <div class="notice"> Click to add. Labeled types prompt for a label (Spill Kits â ##, Emission Points â EP##, Stormwater Outfalls, Bulk Chemical Storage, Waste Accumulation Areas, Safer Areas, Evacuation Points). Drag to move. Right-click to delete. </div>
          <div class="row">
            <button id="saveLayoutBtn">Save Layout</button>
          </div>
        </div>
        <div class="sep"></div>
        <div class="danger" id="warn" style="display: none;"></div>
      </aside>
      <main id="stageWrap">
        <canvas id="stage" width="1545" height="958"></canvas>
        <div id="tooltip" style="display: none; left: 401px; top: 672px;">Fire Extinguisher</div>
      </main>
    </div>
    <!-- Embedded pin data (updated by Save Layout) -->
    <script id="initial-pin-data" type="application/json">
      [{}]
    </script>
    <script>
      // --- Config ---
      const ADMIN_PASSWORD = 'EHS-Admin';
      const IMAGE_PATH = './facility-map.png';
      const TYPES = {
        ext: {
          name: 'Fire Extinguisher',
          color: '#d32',
          labeled: false,
          shape: 'circle'
        },
        spill: {
          name: 'Spill Kit',
          color: '#0b5',
          labeled: true,
          shape: 'pill'
        },
		aed: {
          name: 'AED',
          color: '#e53935',
          labeled: false,
          shape: 'pill'
        },
        shower: {
          name: 'Emergency Shower',
          color: '#08c',
          labeled: false,
          shape: 'triangle'
        },
        eye: {
          name: 'Eyewash',
          color: '#6a3',
          labeled: false,
          shape: 'square'
        },
        ep: {
          name: 'Emission Point',
          color: '#7b1fa2',
          labeled: true,
          shape: 'pill'
        },
        swo: {
          name: 'Stormwater Outfall',
          color: '#1e88e5',
          labeled: true,
          shape: 'hex'
        },
        bulk: {
          name: 'Bulk Chemical Storage',
          color: '#ef6c00',
          labeled: true,
          shape: 'square'
        },
        waa: {
          name: 'Waste Accumulation Area',
          color: '#5d4037',
          labeled: true,
          shape: 'circle'
        },
        safer: {
          name: 'Safer Area',
          color: '#2e7d32',
          labeled: true,
          shape: 'pill'
        },
        evac: {
          name: 'Evacuation Point',
          color: '#c2185b',
          labeled: true,
          shape: 'pill'
        },
      };
      const LAYERS = Object.keys(TYPES).reduce((a, k) => (a[k] = true, a), {});
      // --- State ---
      const state = {
        isAdmin: false, // ensure not logged in by default
        addMode: false,
        selectedType: 'ext',
        img: null,
        imgW: 0,
        imgH: 0,
        zoom: 1,
        panX: 0,
        panY: 0,
        rotDeg: 0,
        points: [],
        dragging: {
          id: null,
          dx: 0,
          dy: 0
        },
        hoverId: null
      };
      // --- DOM ---
      const canvas = document.getElementById('stage');
      const ctx = canvas.getContext('2d');
      const wrap = document.getElementById('stageWrap');
      const tooltip = document.getElementById('tooltip');
      const warnBox = document.getElementById('warn');
      // --- UI init ---
      (function initUI() {
        // Legend with checkboxes
        const legend = document.getElementById('legend');
        legend.innerHTML = '';
        for (const k of Object.keys(TYPES)) {
          const row = document.createElement('label');
          const chk = document.createElement('input');
          chk.type = 'checkbox';
          chk.checked = true;
          chk.onchange = () => {
            LAYERS[k] = chk.checked;
            draw();
          };
          const icon = document.createElement('span');
          icon.innerHTML = iconHTML(k);
          const name = document.createElement('span');
          name.textContent = TYPES[k].name;
          row.appendChild(chk);
          row.appendChild(icon);
          row.appendChild(name);
          legend.appendChild(row);
        }
        // Type select
        const typeSel = document.getElementById('typeSel');
        for (const k of Object.keys(TYPES)) {
          const o = document.createElement('option');
          o.value = k;
          o.textContent = TYPES[k].name;
          typeSel.appendChild(o);
        }
        typeSel.value = state.selectedType;
        typeSel.onchange = () => state.selectedType = typeSel.value;
        // Zoom/rotate
        document.getElementById('zoomIn').onclick = () => {
          state.zoom *= 1.25;
          draw();
        };
        document.getElementById('zoomOut').onclick = () => {
          state.zoom /= 1.25;
          draw();
        };
        document.getElementById('zoomReset').onclick = () => {
          resetView();
          draw();
        };
        const rotateDeg = document.getElementById('rotateDeg');
        rotateDeg.onchange = () => {
          state.rotDeg = (+rotateDeg.value) || 0;
          draw();
        };
        document.querySelectorAll('[data-rot]').forEach(btn => btn.onclick = () => {
          rotateDeg.value = btn.getAttribute('data-rot');
          state.rotDeg = (+rotateDeg.value) || 0;
          draw();
        });
        // Auth (no auto-login)
        document.getElementById('loginBtn').onclick = () => {
          if (document.getElementById('pwd').value === ADMIN_PASSWORD) {
            state.isAdmin = true;
            document.getElementById('authBox').style.display = 'none';
            document.getElementById('adminBox').style.display = '';
            draw();
          }
        };
        document.getElementById('logoutBtn').onclick = () => {
          state.isAdmin = false;
          state.addMode = false;
          document.getElementById('adminBox').style.display = 'none';
          document.getElementById('authBox').style.display = '';
          draw();
        };
        document.getElementById('addToggleBtn').onclick = () => {
          state.addMode = !state.addMode;
          setStatus();
        };
        document.getElementById('cancelAddBtn').onclick = () => {
          state.addMode = false;
          setStatus();
        };
        // Save Layout -> export self-contained HTML
        document.getElementById('saveLayoutBtn').onclick = saveLayout;
        // Optional image picker
        document.getElementById('pickImg').addEventListener('change', (e) => {
          const f = e.target.files?.[0];
          if (!f) return;
          const r = new FileReader();
          r.onload = () => {
            try {
              img.src = r.result;
            } catch {}
          };
          r.readAsDataURL(f);
        });
      })();

      function setStatus() {
        document.getElementById('status').textContent = 'Add: ' + (state.addMode ? ('On (' + TYPES[state.selectedType].name + ')') : 'Off');
      }

      function warn(msg) {
        warnBox.textContent = msg || '';
        warnBox.style.display = msg ? 'block' : 'none';
      }
      // --- Canvas sizing ---
      function resize() {
        canvas.width = wrap.clientWidth;
        canvas.height = wrap.clientHeight;
        draw();
      }
      window.addEventListener('resize', resize);
      // --- Embedded / JSON loading ---
      let hasEmbedded = false;

      function loadEmbeddedPins() {
        const el = document.getElementById('initial-pin-data');
        if (!el) return false;
        try {
          const data = JSON.parse(el.textContent.trim() || '[]');
          if (Array.isArray(data) && data.length) {
            state.points = data;
            hasEmbedded = true;
            return true;
          }
        } catch {}
        return false;
      }
	  
      // --- Local storage (autosave for this device) ---
      function saveLocal() {
        localStorage.setItem('facilityPins', JSON.stringify({
          points: state.points
        }));
      }

      function loadLocal() {
        if (hasEmbedded) return;
        const s = localStorage.getItem('facilityPins');
        if (s) {
          try {
            const j = JSON.parse(s);
            if (Array.isArray(j.points)) state.points = j.points;
          } catch {}
        }
      }
      // --- Image load ---
      const img = new Image();
      img.onload = () => {
        state.img = img;
        state.imgW = img.naturalWidth;
        state.imgH = img.naturalHeight;
        resetView();
        if (!loadEmbeddedPins()) {
          loadSavedPoints().then(ok => {
            if (!ok) loadLocal();
            draw();
          });
        } else {
          draw();
        }
        warn('');
      };
      img.onerror = () => {
        warn('Map image failed to load. Ensure "facility-map.png" is in the same folder, or use Choose Imageâ¦');
        draw();
      };
      img.src = IMAGE_PATH;

      function resetView() {
        const s = Math.min(wrap.clientWidth / state.imgW, wrap.clientHeight / state.imgH);
        state.zoom = s;
        state.panX = (wrap.clientWidth - state.imgW * s) / 2;
        state.panY = (wrap.clientHeight - state.imgH * s) / 2;
      }
      // --- Transform helpers ---
      function deg2rad(d) {
        return d * Math.PI / 180;
      }

      function imageToScreen(ix, iy) {
        const cx = state.imgW / 2,
          cy = state.imgH / 2,
          a = deg2rad(state.rotDeg);
        const dx = ix - cx,
          dy = iy - cy;
        const rx = dx * Math.cos(a) - dy * Math.sin(a) + cx,
          ry = dx * Math.sin(a) + dy * Math.cos(a) + cy;
        return {
          sx: rx * state.zoom + state.panX,
          sy: ry * state.zoom + state.panY
        };
      }

      function screenToImage(sx, sy) {
        const rx = (sx - state.panX) / state.zoom,
          ry = (sy - state.panY) / state.zoom;
        const cx = state.imgW / 2,
          cy = state.imgH / 2,
          a = -deg2rad(state.rotDeg);
        const dx = rx - cx,
          dy = ry - cy;
        const ix = dx * Math.cos(a) - dy * Math.sin(a) + cx,
          iy = dx * Math.sin(a) + dy * Math.cos(a) + cy;
        return {
          ix,
          iy
        };
      }
      // --- Data ops ---
      function addPoint(x, y, type, label) {
        state.points.push({
          id: crypto.randomUUID(),
          type,
          x,
          y,
          label
        });
        saveLocal();
      }

      function getPoint(id) {
        return state.points.find(p => p.id === id);
      }

      function delPoint(id) {
        state.points = state.points.filter(p => p.id !== id);
        saveLocal();
        draw();
      }
      // --- Drawing ---
      function clear() {
        ctx.clearRect(0, 0, canvas.width, canvas.height);
      }

      function draw() {
        clear();
        if (!state.img) return;
        ctx.save();
        ctx.translate(state.panX, state.panY);
        ctx.scale(state.zoom, state.zoom);
        ctx.translate(state.imgW / 2, state.imgH / 2);
        ctx.rotate(deg2rad(state.rotDeg));
        ctx.translate(-state.imgW / 2, -state.imgH / 2);
        ctx.imageSmoothingEnabled = true;
        ctx.imageSmoothingQuality = 'high';
        ctx.drawImage(state.img, 0, 0);
        ctx.restore();
        for (const p of state.points) {
          if (LAYERS[p.type]) drawPoint(p);
        }
      }

      function drawPoint(p) {
        const cfg = TYPES[p.type];
        const {
          sx,
          sy
        } = imageToScreen(p.x, p.y);
        const size = 12;
        ctx.save();
        ctx.lineWidth = 2;
        ctx.strokeStyle = '#fff';
        ctx.fillStyle = cfg.color;
        if (cfg.shape === 'circle') {
          circle(sx, sy, size);
          ctx.fill();
          ctx.stroke();
        } else if (cfg.shape === 'square') {
          rectRound(sx - size, sy - size, size * 2, size * 2, 3);
          ctx.fill();
          ctx.stroke();
        } else if (cfg.shape === 'triangle') {
          triangle(sx, sy, size);
          ctx.fill();
          ctx.stroke();
        } else if (cfg.shape === 'diamond') {
          diamond(sx, sy, size);
          ctx.fill();
          ctx.stroke();
        } else if (cfg.shape === 'hex') {
          hexagon(sx, sy, size);
          ctx.fill();
          ctx.stroke();
        } else if (cfg.shape === 'pill') {
          let txt = (p.label || '').trim();
          if (p.type === 'spill') txt = txt || '00';
		  else if (p.type === 'aed') txt = 'AED';
          else if (p.type === 'ep') {
            if (!txt) txt = 'EP';
            else if (!/^EP/i.test(txt)) txt = 'EP' + txt;
          } else {
            txt = txt || 'LBL';
          }
          const padX = 8,
            h = 20;
          const w = Math.max(28, ctx.measureText(txt).width + padX * 2);
          pill(sx, sy, w, h);
          ctx.fillStyle = cfg.color;
          ctx.fill();
          ctx.stroke();
          ctx.fillStyle = '#fff';
          ctx.font = 'bold 12px system-ui, Arial';
          ctx.textAlign = 'center';
          ctx.textBaseline = 'middle';
          ctx.fillText(txt, sx, sy);
        }
        ctx.restore();

        function circle(x, y, r) {
          ctx.beginPath();
          ctx.arc(x, y, r, 0, Math.PI * 2);
        }

        function rectRound(x, y, w, h, r) {
          ctx.beginPath();
          ctx.moveTo(x + r, y);
          ctx.arcTo(x + w, y, x + w, y + h, r);
          ctx.arcTo(x + w, y + h, x, y + h, r);
          ctx.arcTo(x, y + h, x, y, r);
          ctx.arcTo(x, y, x + w, y, r);
        }

        function triangle(x, y, s) {
          ctx.beginPath();
          ctx.moveTo(x, y - s);
          ctx.lineTo(x + s * 0.866, y + s * 0.5);
          ctx.lineTo(x - s * 0.866, y + s * 0.5);
          ctx.closePath();
        }

        function diamond(x, y, s) {
          ctx.beginPath();
          ctx.moveTo(x, y - s);
          ctx.lineTo(x + s, y);
          ctx.lineTo(x, y + s);
          ctx.lineTo(x - s, y);
          ctx.closePath();
        }

        function hexagon(x, y, s) {
          ctx.beginPath();
          for (let i = 0; i < 6; i++) {
            const a = deg2rad(60 * i - 30);
            const px = x + s * Math.cos(a),
              py = y + s * Math.sin(a);
            i ? ctx.lineTo(px, py) : ctx.moveTo(px, py);
          }
          ctx.closePath();
        }

        function pill(x, y, w, h) {
          const r = h / 2;
          ctx.beginPath();
          ctx.moveTo(x - w / 2 + r, y - h / 2);
          ctx.arcTo(x + w / 2, y - h / 2, x + w / 2, y + h / 2, r);
          ctx.arcTo(x + w / 2, y + h / 2, x - w / 2, y + h / 2, r);
          ctx.arcTo(x - w / 2, y + h / 2, x - w / 2, y - h / 2, r);
          ctx.arcTo(x - w / 2, y - h / 2, x + w / 2, y - h / 2, r);
        }
      }
      // --- Hit-testing ---
      function hitTest(sx, sy) {
        for (let i = state.points.length - 1; i >= 0; i--) {
          const p = state.points[i];
          if (!LAYERS[p.type]) continue;
          const q = imageToScreen(p.x, p.y);
          if (Math.hypot(q.sx - sx, q.sy - sy) < 14) return p.id;
        }
        return null;
      }
      // --- Interaction ---
      let isPanning = false,
        lastX = 0,
        lastY = 0;
      canvas.addEventListener('wheel', (e) => {
        e.preventDefault();
        const mx = e.offsetX,
          my = e.offsetY;
        const z0 = state.zoom;
        const dz = Math.pow(1.0015, -e.deltaY);
        const z1 = Math.max(0.05, Math.min(20, z0 * dz));
        const {
          ix,
          iy
        } = screenToImage(mx, my);
        state.zoom = z1;
        const {
          sx,
          sy
        } = imageToScreen(ix, iy);
        state.panX += mx - sx;
        state.panY += my - sy;
        draw();
      }, {
        passive: false
      });
      canvas.addEventListener('mousemove', (e) => {
        const mx = e.offsetX,
          my = e.offsetY;
        const id = hitTest(mx, my);
        state.hoverId = id;
        if (id) {
          const p = getPoint(id);
          const label = (TYPES[p.type].labeled && p.label) ? (p.type === 'ep' && !/^EP/i.test(p.label) ? 'EP' + p.label : p.label) : '';
          tooltip.textContent = TYPES[p.type].name + (label ? ': ' + label : '');
          tooltip.style.left = (mx + 12) + 'px';
          tooltip.style.top = (my + 12) + 'px';
          tooltip.style.display = 'block';
        } else {
          tooltip.style.display = 'none';
        }
        if (state.dragging.id) {
          const {
            ix,
            iy
          } = screenToImage(mx - state.dragging.dx, my - state.dragging.dy);
          const p = getPoint(state.dragging.id);
          if (p) {
            p.x = ix;
            p.y = iy;
            draw();
          }
          return;
        }
        if (isPanning) {
          state.panX += (mx - lastX);
          state.panY += (my - lastY);
          lastX = mx;
          lastY = my;
          draw();
          return;
        }
      });
      canvas.addEventListener('mouseleave', () => {
        state.hoverId = null;
        tooltip.style.display = 'none';
        draw();
      });
      window.addEventListener('mouseup', () => {
        if (state.dragging.id) {
          state.dragging.id = null;
          saveLocal();
        }
        isPanning = false;
      });
      canvas.addEventListener('mousedown', (e) => {
        const mx = e.offsetX,
          my = e.offsetY;
        const id = hitTest(mx, my);
        if (state.isAdmin && id) {
          const p = getPoint(id);
          const {
            sx,
            sy
          } = imageToScreen(p.x, p.y);
          state.dragging.id = id;
          state.dragging.dx = mx - sx;
          state.dragging.dy = my - sy;
          return;
        }
        if (state.isAdmin && state.addMode) {
          const {
            ix,
            iy
          } = screenToImage(mx, my);
          const t = state.selectedType;
          let label = '';
          if (TYPES[t].labeled) {
            const defaultLbl = t === 'spill' ? '00' : (t === 'ep' ? 'EP' : '');
            const v = prompt(`Enter label for ${TYPES[t].name}${defaultLbl?` (e.g., ${defaultLbl}12)`:''}:`);
            if (v === null) return;
            label = v.trim();
            if (t === 'ep' && label && !/^EP/i.test(label)) label = 'EP' + label;
          }
          addPoint(ix, iy, t, label);
          draw();
          return;
        }
        isPanning = true;
        lastX = mx;
        lastY = my;
      });
      // labeled item click -> edit label; unlabeled -> no popup
      canvas.addEventListener('click', (e) => {
        if (!state.isAdmin) return;
        const id = hitTest(e.offsetX, e.offsetY);
        if (!id) return;
        const p = getPoint(id);
        if (!p) return;
        if (!TYPES[p.type].labeled) return;
        const v = prompt(`Edit label for ${TYPES[p.type].name}:`, p.label || '');
        if (v !== null) {
          p.label = v.trim();
          if (p.type === 'ep' && p.label && !/^EP/i.test(p.label)) p.label = 'EP' + p.label;
          saveLocal();
          draw();
        }
      });
      // right-click delete
      canvas.addEventListener('contextmenu', (e) => {
        e.preventDefault();
        if (!state.isAdmin) return;
        const id = hitTest(e.offsetX, e.offsetY);
        if (!id) return;
        const p = getPoint(id);
        if (confirm(`Delete ${TYPES[p.type].name}${TYPES[p.type].labeled&&p.label? ' ('+p.label+')':''}?`)) delPoint(id);
      });
      // --- Legend icons ---
      function iconHTML(type) {
        const c = TYPES[type].color;
        if (TYPES[type].shape === 'pill') {
          const text = type === 'spill' ? 'SK' : type === 'aed' ? 'AED' : type === 'ep' ? 'EP' : type === 'safer' ? 'SAFE' : type === 'evac' ? 'EVAC' : 'LBL';
          return `
																			<span style="display:inline-block;min-width:28px;padding:2px 6px;border-radius:999px;background:${c};color:#fff;font-weight:700;font-size:12px;text-align:center;">${text}</span>`;
        }
        if (TYPES[type].shape === 'circle') return svg(`
																			<circle cx='9' cy='9' r='7' fill='${c}' stroke='white' stroke-width='2'/>`);
        if (TYPES[type].shape === 'square') return svg(`
																			<rect x='3' y='3' width='12' height='12' rx='3' fill='${c}' stroke='white' stroke-width='2'/>`);
        if (TYPES[type].shape === 'triangle') return svg(`
																			<polygon points='9,2 16,16 2,16' fill='${c}' stroke='white' stroke-width='2'/>`);
        if (TYPES[type].shape === 'diamond') return svg(`
																			<polygon points='9,2 16,9 9,16 2,9' fill='${c}' stroke='white' stroke-width='2'/>`);
        if (TYPES[type].shape === 'hex') return svg(`
																			<polygon points='4,5 9,2 14,5 14,13 9,16 4,13' fill='${c}' stroke='white' stroke-width='2'/>`);

        function svg(inner) {
          return `
																			<svg width='18' height='18' viewBox='0 0 18 18' aria-hidden='true'>${inner}</svg>`;
        }
      }
      // --- Save Layout -> export self-contained HTML with embedded pins ---
      function saveLayout() {
        try {
          let html = document.documentElement.outerHTML;
          // 0) Reset typeSel dropdown to a clean placeholder
          html = html.replace(/ < select id = "typeSel" [\s\ S] * ? < \/select>/i, ' < select id = "typeSel" > < /select>');
          // 1) Embed current pins
          const updatedPins = JSON.stringify(state.points, null, 2);
          html = html.replace(/ < script id = "initial-pin-data" [ ^ > ] * > [\s\ S] * ? < \/script>/i, `
																					<script id="initial-pin-data" type="application/json">\n${updatedPins}\n<\/script>`);
          // 2) Force logged-out UI in the exported file
          html = html.replace(/ < div id = "adminBox" [ ^ > ] * > /i, (m)=>{
            return /style=/i.test(m) ? m.replace(/style="[^"]*"/i, 'style="display:none;"') : m.replace(/>$/, ' style="display:none;">');
          });
        html = html.replace(/ < div id = "authBox" [ ^ > ] * > /i, (m)=>{
          return /style=/i.test(m) ? m.replace(/style="[^"]*"/i, '') : m;
        });
      html = html.replace(/( < input[ ^ > ] * id = "pwd" [ ^ > ] * ? )\ s * value = "[^"] * "/i, '$1');
      // 3) Download updated HTML
      const blob = new Blob([html], {
        type: 'text/html'
      });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'index.html';
      document.body.appendChild(a);
      a.click();
      a.remove();
      setTimeout(() => URL.revokeObjectURL(url), 2000);
      }
      catch (err) {
        console.error(err);
        alert('Export failed.');
      }
      }

      function updateLegendForPrint() {
        document.querySelectorAll('.legend label').forEach(lbl => {
          const cb = lbl.querySelector('input[type="checkbox"]');
          if (cb && !cb.checked) {
            lbl.classList.add('print-hide');
          }
        });
      }

      function cleanupLegendAfterPrint() {
        document.querySelectorAll('.legend label.print-hide').forEach(lbl => lbl.classList.remove('print-hide'));
      }
      window.addEventListener('beforeprint', updateLegendForPrint);
      window.addEventListener('afterprint', cleanupLegendAfterPrint);
      // --- Kickoff ---
      resize();
    </script>
  </body>
</html>
